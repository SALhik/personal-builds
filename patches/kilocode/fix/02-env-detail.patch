file src/core/environment/getEnvironmentDetails.ts
label export async function getEnvironmentDetails(cline: Task, includeFileDetails: boo

 		terminalOutputLineLimit = 500,
 		terminalOutputCharacterLimit = DEFAULT_TERMINAL_OUTPUT_CHARACTER_LIMIT,
 		maxWorkspaceFiles = 200,
+    maxOpenTabsContext = 20
 	} = state ?? {}
 
 	// It could be useful for cline to know if the user went from one or no
 	// file to another between messages, so we always include this context.
 	const visibleFilePaths = vscode.window.visibleTextEditors
 		?.map((editor) => editor.document?.uri?.fsPath)
 		.filter(Boolean)
 		.map((absolutePath) => path.relative(cline.cwd, absolutePath))
-		.slice(0, maxWorkspaceFiles)
+		.slice(0, !maxOpenTabsContext ? 0 : maxWorkspaceFiles)
 
 	// Filter paths through rooIgnoreController
-	const allowedVisibleFiles = cline.rooIgnoreController
+	const allowedVisibleFiles = (cline.rooIgnoreController
 		? cline.rooIgnoreController.filterPaths(visibleFilePaths)
-		: visibleFilePaths.map((p) => p.toPosix()).join("\n")
+		: visibleFilePaths.map((p) => p.toPosix())).filter(Boolean)
 
-	if (allowedVisibleFiles) {
+	if (allowedVisibleFiles.length > 0) {
 		details += "\n\n# VSCode Visible Files"
-		details += `\n${allowedVisibleFiles}`
+		details += `\n${allowedVisibleFiles.join("\n").trim()}`
 	}
 
-	const { maxOpenTabsContext } = state ?? {}
-	const maxTabs = maxOpenTabsContext ?? 20
 	const openTabPaths = vscode.window.tabGroups.all
 		.flatMap((group) => group.tabs)
 		.filter((tab) => tab.input instanceof vscode.TabInputText)
 		.map((tab) => (tab.input as vscode.TabInputText).uri.fsPath)
 		.filter(Boolean)
 		.map((absolutePath) => path.relative(cline.cwd, absolutePath).toPosix())
-		.slice(0, maxTabs)
+		.slice(0, maxOpenTabsContext)
 
 	// Filter paths through rooIgnoreController
-	const allowedOpenTabs = cline.rooIgnoreController
+	const allowedOpenTabs = (cline.rooIgnoreController
 		? cline.rooIgnoreController.filterPaths(openTabPaths)
-		: openTabPaths.map((p) => p.toPosix()).join("\n")
+		: openTabPaths.map((p) => p.toPosix())).filter(Boolean)
 
-	if (allowedOpenTabs) {
+	if (allowedOpenTabs.length > 0) {
 		details += "\n\n# VSCode Open Tabs"
-		details += `\n${allowedOpenTabs}`
+		details += `\n${allowedOpenTabs.join("\n").trim()}`
 	}
 
 	// Get task-specific and background terminals.
